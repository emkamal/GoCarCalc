<!DOCTYPE html>
<html>

<head>
    <title>GoCar Profit Calculator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🤑</text></svg>">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap-dark.min.css">
    <link href="style.css" rel="stylesheet" type="text/css">
</head>

<body class="bg-dark text-light">
    <nav class="navbar fixed-top navbar-dark bg-primary">
        <a class="navbar-brand" href="#">
            GoCar Profit Calculator
        </a>
        <h4 class="navbar-text">🚗</h4>
    </nav>
    <form id="mainForm">
        <div class="row">
            <div class="col col-md-12">
                <div class="form-group">
                    <label for="gopayRevenue">Gopay Revenue (Rp):</label>
                    <input type="number" id="gopayRevenue" name="gopayRevenue" class="form-control"
                        placeholder="e.g 250000">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col col-md-12">
                <div class="form-group">
                    <label for="cashRevenue">Cash Revenue (Rp):</label>
                    <input type="number" id="cashRevenue" name="cashRevenue" class="form-control"
                        placeholder="e.g 150000">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col col-md-12">
                <div class="form-group">
                    <label for="keptDeposit">Kept Deposit (Rp):</label>
                    <input type="number" id="keptDeposit" name="keptDeposit" class="form-control disabledByDefault"
                        placeholder="e.g 10000" disabled>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col col-md-12">
                <div class="form-group">
                    <label for="distanceTravelled">Distance Travelled (KM):</label>
                    <input type="number" id="distanceTravelled" name="distanceTravelled" class="form-control"
                        placeholder="e.g 165">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col col-md-12">
                <div class="form-group">
                    <label for="averageFuelConsumption">Average Fuel Consumption (KM/L):</label>
                    <input type="number" id="averageFuelConsumption" name="averageFuelConsumption" class="form-control"
                        placeholder="e.g 11.6">
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col col-md-6">
                <div class="form-group">
                    <label for="parkingExpense">Parking Expense:</label>
                    <input type="number" id="parkingExpense" name="parkingExpense" class="form-control"
                        placeholder="e.g 10000">
                </div>
            </div>
            <div class="col col-md-6">
                <div class="form-group">
                    <label for="tollExpense">Toll Expense:</label>
                    <input type="number" id="tollExpense" name="tollExpense" class="form-control"
                        placeholder="e.g 5000">
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col col-md-12">
                <div class="form-group">
                    <label for="fuelPrice">Fuel Price (Rp):</label>
                    <input type="number" id="fuelPrice" name="fuelPrice" value="10000"
                        class="form-control disabledByDefault" disabled>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col col-md-12">
                <div class="form-group">
                    <label for="carMaintenanceCost">Car Maintenance Cost (%):</label>
                    <input type="number" id="carMaintenanceCost" name="carMaintenanceCost" value="10"
                        class="form-control disabledByDefault" disabled>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col col-md-12">
                <div class="row">
                    <div class="col col-md-6">
                        <div class="form-group">
                            <label for="carOwnerShare">Car Owner Share (%):</label>
                            <input type="number" id="carOwnerShare" name="carOwnerShare" value="50"
                                class="form-control disabledByDefault" disabled>
                        </div>
                    </div>
                    <div class="col col-md-6">
                        <div class="form-group">
                            <label for="carDriverShare">Car Driver Share (%):</label>
                            <input type="number" id="carDriverShare" name="carDriverShare" value="50"
                                class="form-control disabledByDefault" disabled>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row checkBoxRow">
            <div class="col col-md-12">
                <div class="form-group row">
                    <div class="col col-md-12 text-right">
                        <div class="form-group">
                            <label for="unlock">
                                <input type="checkbox" id="unlock" name="unlock" onclick="unlockFields()"> Unlock all
                                fields
                            </label>
                            <label for="hide">
                                <input type="checkbox" id="hide" name="hide" onclick="hideDisabledFields()" checked>
                                Hide disabled fields
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="fixed-bottom bottomBar">
            <div class="container-fluid">
                <div class="row">
                    <div class="col col-md-12">
                        <div class="form-group">
                            <input type="button" class="btn btn-primary" value="Calculate" onclick="calculateProfit()">
                            <input id="secButton" type="button" class="btn btn-secondary" value="Load sample"
                                onclick="LoadSample()">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
    <br>
    <div id="result"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.0/html2canvas.min.js"></script>


    <script>
        function calculateProfit() {
            var gopayRevenue = parseFloat(document.getElementById("gopayRevenue").value);
            var cashRevenue = parseFloat(document.getElementById("cashRevenue").value) || 0;
            var keptDeposit = parseFloat(document.getElementById("keptDeposit").value) || 0;
            var distanceTravelled = parseFloat(document.getElementById("distanceTravelled").value);
            var averageFuelConsumption = parseFloat(document.getElementById("averageFuelConsumption").value);
            var parkingExpense = parseFloat(document.getElementById("parkingExpense").value) || 0;
            var tollExpense = parseFloat(document.getElementById("tollExpense").value) || 0;
            var fuelPrice = parseFloat(document.getElementById("fuelPrice").value);
            var carMaintenanceCost = parseFloat(document.getElementById("carMaintenanceCost").value);
            var ownerShare = parseFloat(document.getElementById("carOwnerShare").value);
            var driverShare = parseFloat(document.getElementById("carDriverShare").value);

            if (isNaN(gopayRevenue) || isNaN(distanceTravelled) || isNaN(averageFuelConsumption)) {
                document.getElementById("result").innerHTML = "<div class='alert alert-danger'>Please fill all the fields with valid numbers</div>";
                if (isNaN(gopayRevenue)) {
                    document.getElementById("gopayRevenue").classList.add("is-invalid");
                } else {
                    document.getElementById("gopayRevenue").classList.remove("is-invalid");
                }
                if (isNaN(distanceTravelled)) {
                    document.getElementById("distanceTravelled").classList.add("is-invalid");
                } else {
                    document.getElementById("distanceTravelled").classList.remove("is-invalid");
                }
                if (isNaN(averageFuelConsumption)) {
                    document.getElementById("averageFuelConsumption").classList.add("is-invalid");
                } else {
                    document.getElementById("averageFuelConsumption").classList.remove("is-invalid");
                }
                return;
            }

            var grossRevenue = gopayRevenue + cashRevenue;

            var fuelCost = distanceTravelled / averageFuelConsumption * fuelPrice;
            var grossIncome = grossRevenue - fuelCost - keptDeposit - parkingExpense - tollExpense;
            var maintenanceCost = (grossIncome * carMaintenanceCost) / 100;
            var netIncome = grossIncome - maintenanceCost;
            var fundsOnPocket = gopayRevenue - fuelCost - keptDeposit - maintenanceCost;
            var ownerIncome = (netIncome * ownerShare) / 100;
            var driverIncome = (netIncome * driverShare) / 100;

            var transferToOwnerFromPocket = 0;
            var transferToDriverFromPocket = 0;
            var transferToOwnerFromCash = 0;
            var transferToDriverFromCash = 0;

            if (ownerIncome < fundsOnPocket) {
                transferToOwnerFromPocket = ownerIncome;
                transferToOwnerFromCash = 0;
                transferToDriverFromPocket = fundsOnPocket - ownerIncome;
                transferToDriverFromCash = driverIncome - transferToDriverFromPocket;
            } else {
                transferToOwnerFromPocket = fundsOnPocket;
                transferToOwnerFromCash = ownerIncome - fundsOnPocket;
                transferToDriverFromPocket = 0;
                transferToDriverFromCash = driverIncome;
            }

            const table = document.createElement("table");
            table.classList.add("table");
            table.classList.add("table-dark");

            const thead = document.createElement("thead");
            const tr = document.createElement("tr");

            const th1 = document.createElement("th");
            th1.textContent = "Account";

            const th2 = document.createElement("th");
            th2.textContent = "Amount (Rp)";

            tr.appendChild(th1);
            tr.appendChild(th2);
            thead.appendChild(tr);
            table.appendChild(thead);

            const tbody = document.createElement("tbody");

            addRow(tbody, "💰 Gross Revenue", "Rp", addThousandSeparator(grossRevenue));
            addRow(tbody, "⛽ Fuel Cost", "Rp", addThousandSeparator(fuelCost));
            addRow(tbody, "💸 Gross Income", "Rp", addThousandSeparator(grossIncome));
            addRow(tbody, "🛠️ Maintenance Cost", "Rp", addThousandSeparator(maintenanceCost));
            addRow(tbody, "🤑 Net Income", "Rp", addThousandSeparator(netIncome), ["bg-success", "mainInfoRow"]);
            addRow(tbody, "🏧 Funds on Pocket", "Rp", addThousandSeparator(fundsOnPocket), []);

            table.appendChild(tbody);

            // create another table
            const table2 = document.createElement("table");
            table2.classList.add("table");
            table2.classList.add("table-dark");

            // create thead with 2 columns, first one is Owner, second one is Driver
            const thead2 = document.createElement("thead");
            const tr2 = document.createElement("tr");
            const th20 = document.createElement("th");
            th20.textContent = "";
            const th21 = document.createElement("th");
            th21.textContent = "Owner";
            const th22 = document.createElement("th");
            th22.textContent = "Driver";
            tr2.appendChild(th20);
            tr2.appendChild(th21);
            tr2.appendChild(th22);
            thead2.appendChild(tr2);
            table2.appendChild(thead2);

            // create tbody with 2 columns, first one is Transfer to Owner, second one is Transfer to Driver
            const tbody2 = document.createElement("tbody");
            // create row with 3 columns, the first column says "Income", the second column contain Owner income, the third column contain Driver income
            const tr20 = document.createElement("tr");
            tr20.classList.add("bg-primary", "mainInfoRow");
            const td20 = document.createElement("td");
            td20.textContent = "Income";
            const td21 = document.createElement("td");
            td21.textContent = addThousandSeparator(ownerIncome);
            const td22 = document.createElement("td");
            td22.textContent = addThousandSeparator(driverIncome);
            tr20.appendChild(td20);
            tr20.appendChild(td21);
            tr20.appendChild(td22);
            tbody2.appendChild(tr20);

            const tr21 = document.createElement("tr");
            tr21.classList.add("mainInfoRow");
            const td211 = document.createElement("td");
            td211.textContent = "Transfer to";
            td211.colSpan = 3;
            const tr22 = document.createElement("tr");
            const td221 = document.createElement("td");
            td221.textContent = "From pocket";
            const td222 = document.createElement("td");
            td222.textContent = addThousandSeparator(transferToOwnerFromPocket);
            const td223 = document.createElement("td");
            td223.textContent = addThousandSeparator(transferToDriverFromPocket);
            const tr23 = document.createElement("tr");
            const td231 = document.createElement("td");
            td231.textContent = "From cash";
            const td232 = document.createElement("td");
            td232.textContent = addThousandSeparator(transferToOwnerFromCash);
            const td233 = document.createElement("td");
            td233.textContent = addThousandSeparator(transferToDriverFromCash);
            tr21.appendChild(td211);
            tr22.appendChild(td221);
            tr22.appendChild(td222);
            tr22.appendChild(td223);
            tr23.appendChild(td231);
            tr23.appendChild(td232);
            tr23.appendChild(td233);
            tbody2.appendChild(tr21);
            tbody2.appendChild(tr22);
            tbody2.appendChild(tr23);

            table2.appendChild(tbody2);


            document.getElementById("result").innerHTML = "";
            document.getElementById("result").appendChild(table);
            document.getElementById("result").appendChild(table2);
            document.getElementById("result").style.opacity = 1;
            document.getElementById("result").scrollIntoView({ behavior: "smooth" });

            // serialize all input data into a url parameter string
            const urlParams = new URLSearchParams();

            urlParams.append("gopayRevenue", gopayRevenue);
            urlParams.append("cashRevenue", cashRevenue);
            urlParams.append("distanceTravelled", distanceTravelled);
            urlParams.append("averageFuelConsumption", averageFuelConsumption);
            urlParams.append("parkingExpense", parkingExpense);
            urlParams.append("tollExpense", tollExpense);
            urlParams.append("fuelPrice", fuelPrice);
            urlParams.append("carMaintenanceCost", carMaintenanceCost);
            urlParams.append("ownerShare", ownerShare);
            urlParams.append("driverShare", driverShare);

            // append the urlParams to the current url with # symbol
            window.location.hash = urlParams.toString();

            // add share button to result div
            const shareButton = document.createElement("button");
            shareButton.classList.add("shareButton");
            shareButton.classList.add("btn");
            shareButton.classList.add("btn-primary");
            shareButton.textContent = "Share Calculation Result";
            shareButton.addEventListener("click", async function () {
                if (navigator.share) {
    try {
      // add custom styles to the elements that will be included in the screenshot
      const style = document.createElement("style");
      style.textContent = `
      body{
        margin: 10px;
        padding: 20px;
      }
      div#result{
        margin: 0;
      }
        .navbar, .shareButton, .bottomBar, .checkBoxRow {
          display: none;
        }
        .result-table {
          border-collapse: collapse;
          margin: 20px;
        }
        .result-table th,
        .result-table td {
          border: 1px solid black;
          padding: 5px;
        }
      `;
      document.head.appendChild(style);

      // capture a screenshot of the page using html2canvas
      const canvas = await html2canvas(document.body, {
        // use the custom styles when capturing the screenshot
        useCORS: true,
        scrollX: 0,
        scrollY: -window.scrollY,
        windowWidth: document.documentElement.clientWidth,
        windowHeight: document.documentElement.clientHeight,
        scale: 2,
        backgroundColor: null,
        logging: true,
        letterRendering: true,
        allowTaint: true,
        foreignObjectRendering: true,
        onclone: function (cloneDoc) {
          cloneDoc.querySelectorAll(".result-table").forEach(function (table) {
            table.classList.add("table");
            table.classList.add("table-bordered");
          });
        }
      });

      // convert the canvas to a data URL
      const imageDataUrl = canvas.toDataURL();

      // share the content with the screenshot as an image
      await navigator.share({
        title: "GoCar Profit",
        text: `*Result*:
          Fuel cost: Rp${addThousandSeparator(fuelCost)}
          Maintenance cost: Rp${addThousandSeparator(maintenanceCost)}
          Shared Profit: Rp${addThousandSeparator(ownerIncome)}
          Transfer to Owner from pocket: Rp${addThousandSeparator(transferToOwnerFromPocket)}
          Transfer to Owner from cash: Rp${addThousandSeparator(transferToOwnerFromCash)}
          Transfer to Driver from pocket: Rp${addThousandSeparator(transferToDriverFromPocket)}
          Transfer to Driver from cash: Rp${addThousandSeparator(transferToDriverFromCash)}

          Click the link below to see the full calculation:
        `,
        url: window.location.href,
        // files: [new File([await (await fetch(imageDataUrl)).blob()], "screenshot.png", { type: "image/png" })]
      });
      console.log("Content shared successfully.");
    } catch (error) {
      console.error("Error sharing content:", error);
    }
  } else {
    console.warn("Web Share API not supported on this device.");
  }
            });
            document.getElementById("result").appendChild(shareButton);




            // create a button element with class btn and btn-primary and text "Save Data", the action should be to store all the data above to a local file using File API
            const saveButton = document.createElement("button");
            saveButton.classList.add("btn");
            saveButton.classList.add("btn-primary");
            saveButton.textContent = "Save Data";
            saveButton.addEventListener("click", function () {
                const data = {
                    grossRevenue: grossRevenue,
                    distanceTravelled: distanceTravelled,
                    averageFuelConsumption: averageFuelConsumption,
                    parkingExpense: parkingExpense,
                    tollExpense: tollExpense,
                    fuelPrice: fuelPrice,
                    carMaintenanceCost: carMaintenanceCost,
                    ownerShare: ownerShare,
                    driverShare: driverShare
                };

                saveDataToFile(data);
                // const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
                // const url = URL.createObjectURL(blob);
                // const a = document.createElement("a");
                // a.href = url;
                // a.download = "data.json";
                // a.click();
            });
            // document.getElementById("result").appendChild(saveButton);
        }

        function saveDataToFile(data) {
            var file = new File([data], "data.txt", { type: "text/plain" });
            var writer = new FileWriter();

            writer.onwriteend = function () {
                console.log("Data saved to file.");
            };

            writer.onerror = function () {
                console.error("Error saving data to file.");
            };

            writer.write(file);
        }

        function addThousandSeparator(num) {
            num = Math.round(num);
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function addRow(tbody, name, unit, value, className) {
            const row = document.createElement("tr");
            if (className) {
                if (typeof className === "string") {
                    className = [className];
                }
                className.forEach(function (className) {
                    row.classList.add(className);
                });
            }
            const rowtd1 = document.createElement("td");
            rowtd1.textContent = name;
            const rowtd2 = document.createElement("td");
            rowtd2.classList.add("text-right");
            rowtd2.textContent = unit + " " + value;
            row.appendChild(rowtd1);
            row.appendChild(rowtd2);
            tbody.appendChild(row);
        }

        function LoadSample() {
            document.getElementById("gopayRevenue").value = 250000;
            document.getElementById("cashRevenue").value = 150000;
            document.getElementById("distanceTravelled").value = 200;
            document.getElementById("averageFuelConsumption").value = 10;
            calculateProfit();
            monitorFields();
        }
        function clear() {
            var enabledFields = document.querySelectorAll('input[type="number"]:not(.disabledByDefault)');
            enabledFields.forEach(function (field) {
                field.value = "";
                field.classList.remove("is-invalid");
            });
            const result = document.getElementById("result");
            result.style.opacity = 1;

            const fadeEffect = setInterval(function () {
                if (result.style.opacity > 0) {
                    result.style.opacity -= 0.1;
                } else {
                    clearInterval(fadeEffect);
                    result.innerHTML = "";
                }
            }, 50);
            monitorFields();
            document.documentElement.scrollIntoView({ behavior: "smooth" });
            window.location.hash = "";
        }
        function unlockFields() {
            var inputs = document.querySelectorAll('input.disabledByDefault');
            for (var i = 0; i < inputs.length; i++) {
                if (inputs[i].disabled) {
                    inputs[i].disabled = false;
                } else {
                    inputs[i].disabled = true;
                }
            }
        }
        function hideDisabledFields() {
            if (document.getElementById("hide").checked == true) {
                // Get all disabled fields
                var disabledFields = document.querySelectorAll('input:disabled');

                // Loop through each disabled field
                for (var i = 0; i < disabledFields.length; i++) {
                    // Find the closest parent element with class "row"
                    var row = disabledFields[i].closest('.row');

                    // Hide the row
                    if (row) {
                        row.style.display = "none";
                    }
                }
            } else {
                // Get all rows that were previously hidden
                var hiddenRows = document.querySelectorAll('.row[style="display: none;"]');

                // Loop through each hidden row
                for (var i = 0; i < hiddenRows.length; i++) {
                    // Show the row
                    hiddenRows[i].style.display = "flex";
                }
            }
        }
        hideDisabledFields();

        function monitorFields() {
            var enabledFields = document.querySelectorAll('input[type="number"]:not(.disabledByDefault)');
            var button = document.getElementById("secButton");

            // loop through all enabled fields
            for (var i = 0; i < enabledFields.length; i++) {
                // if any of the enabled fields are not empty, change the button to "Clear"
                if (enabledFields[i].value !== "") {
                    button.value = "Clear";
                    button.onclick = clear;
                    return;
                }
            }

            button.value = "Load Sample";
            button.onclick = LoadSample;
        }

        // Call the monitorFields function whenever the value of an enabled field changes
        document.querySelectorAll('input:not(.disabledByDefault)').forEach(function (field) {
            field.addEventListener("change", monitorFields);
        });

        // add keyup event listener to all fields where if the user press ctrl+enter, the calculateProfit function will be called
        document.querySelectorAll('input[type="number"]').forEach(function (field) {
            field.addEventListener("keyup", function (event) {
                if (event.ctrlKey && event.key === "Enter") {
                    calculateProfit();
                }
            });
        });

        // if the url contains a hash
        if (window.location.hash) {
            // get and parse the hash
            var hash = window.location.hash.substring(1);

            const hashParams = new URLSearchParams(hash);

            const hashData = {};

            hashParams.forEach(function (value, key) {
                hashData[key] = value;
            });
            // loop through each key in the hashData
            for (var key in hashData) {
                // if the key is a valid field id
                if (document.getElementById(key)) {
                    // set the value of the field to the value in the hash
                    document.getElementById(key).value = hashData[key];
                }
            }
            // calculate the profit
            calculateProfit();
        }


        


    </script>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
      
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyD93ywEtZFVddul9WleIRofZt7353MzpWU",
          authDomain: "gocarcalc.firebaseapp.com",
          projectId: "gocarcalc",
          storageBucket: "gocarcalc.appspot.com",
          messagingSenderId: "1057068768631",
          appId: "1:1057068768631:web:894ac29de883c4fe00d572",
          measurementId: "G-ZFQT7HZ1N7"
        };
      
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
      </script>
</body>

</html>